* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v2.0 on Nov, 03. 2017. JOBID=1509728524
* GENERATES WATER MOLECULES IN THE PORE OF THE PROTEIN
*

DIMENS CHSIZE 3000000 MAXRES 3000000

! Read topology and parameter files
stream toppar.str

! Read PSF and Coordinates
open read unit 10 card name step1_pdbreader.psf
read psf  unit 10 card

open read unit 10 card name step2_orient.crd
read coor unit 10 card

!
! Step1: Overlay Water
!

bomblev -1
coor stat sele ( prop Z .lt. 18 ) .and. ( prop Z .gt. -18 ) end
if ?nsel .eq. 0 then
  open write unit 90 card name step2.1_pore.str
  write title unit 90
  * set nwater 0
  *
  stop
endif

set Xinit = ( ?xmax - ?xmin )
set Yinit = ( ?ymax - ?ymin )
set Zinit = 36                 ! -18 < Z < 18

delete atom sele all end

!Water Box Generation
stream step2.1_pore_watbox.str

delete atom sele all end

!Read Protein & Water
open read unit 10 card name step1_pdbreader.psf
read psf  unit 10 card

open read unit 10 card name step2_orient.crd
read coor unit 10 card

stream step2.1_pore.str

open read card unit 10 name step2.1_porewat.crd
read coor card unit 10 append

!Remove overlapped water
define TOTO sele .not. hydrogen .and. .not. type OH2 end
coor stat sele TOTO end

delete atom sele .byres. ( type OH2 .and. ( TOTO .around. 2.8 ) ) end
!
! Step2: Initial Carving Out
!

set  deg    = 0
set  maxdeg = 90.0
set  dstep  = 12
calc ddeg   = @maxdeg / @dstep
define CARVE sele none end

label rotate0
calc tzmax =   @Zinit / 2 + 2
calc tzmin =  -@Zinit / 2 - 2
set zslab  =   2
calc slabmax = @tzmax
calc slabmin = @tzmax - @zslab

label carve0
coor stat sele ( .not. segid SOLV ) .and. ( prop Z .gt. @slabmin .and. prop Z .lt. @slabmax ) end
define CARVE sele CARVE .or. .byres. ( ( type OH2 ) .and. -
                           ( prop Z .gt. @slabmin .and. prop Z .lt. @slabmax ) .and. -
                           ( prop X .gt. ?xmax    .or. prop X .lt. ?xmin  .or. -
                             prop Y .gt. ?ymax    .or. prop Y .lt. ?ymin    ) ) end

calc slabmax = @slabmax - @zslab
calc slabmin = @slabmin - @zslab
if slabmax .gt. @tzmin goto carve0

increase deg by @ddeg
if deg .lt. @maxdeg then
  coor rotate zdir 1.0 phi @ddeg sele all end
  goto rotate0
endif
if deg .ge. @maxdeg then
  decrease deg by @ddeg
  coor rotate zdir -1.0 phi @deg sele all end
endif

delete atom sele CARVE end

!
! Step3: Dynamics
!

!Run Langevin simulations only for water
scalar charge = zero

nbonds atom vatom vswitch bycb -
       ctonnb 2.5 ctofnb 2.5 cutnb 8.0 cutim 8.0 -
       inbfrq -1 imgfrq -1 wmin 1.0 cdie eps 1.0

cons fix sele .not. segid SOLV end
mini sd   nstep 50
mini abnr nstep 50

label dorun

join SOLV renumber

scalar SCA1 = X
scalar SCA2 = Y

MMFP            ! keep water below +/- 12
GEO  reset
GEO  plane xref 0.0 yref 0.0 zref 0.0 zdir 1.0 -
     harmonic inside  force 25.0 droff  8.0 select type OH2 .and. ( prop Z .gt.  -8 ) .and. ( prop Z .lt.  8 ) end
GEO  plane xref 0.0 yref 0.0 zref 0.0 zdir 1.0 -
     harmonic inside  force 25.0 droff 15.0 select type OH2 .and. ( prop Z .gt. -15 ) .and. ( prop Z .lt. 15 ) end
GEO  plane xref 0.0 yref 0.0 zref 0.0 zdir 1.0 -
     harmonic inside  force 25.0 droff 17.0 select type OH2 .and. ( prop Z .gt. -17 ) .and. ( prop Z .lt. 17 ) end
GEO  plane xref 0.0 yref 0.0 zref 0.0 zdir 1.0 -
     harmonic inside  force 25.0 droff 18.0 select type OH2 .and. ( prop Z .gt. -18 ) .and. ( prop Z .lt. 18 ) end
GEO  plane xref 0.0 yref 0.0 zref 0.0 zdir 1.0 -
     harmonic inside  force 25.0 droff 18.0 select type OH2 end
END
calc temp  = 5000.0
set nstep = 2000

shake bonh param fast
scalar fbeta set 3.0 select .not. type H* end

DYNAMICS LANGEVIN -
         start         nstep  @nstep  timestp 0.001  -
         inbfrq    -1  imgfrq     -1  ihbfrq      0  ilbfrq      0 -
         firstt @temp  finalt  @temp  tstruc  @temp  -
         tbath  @temp  rbuf      0.0  -
         iunread   -1  iunwrite   -1  iuncrd     -1  iunvelo    -1 -
         nsavc      0  nsavvelo    0  -
         nprint   100  iprfrq   1000  isvfrq   1000  ntrfrq   5000 -
         iasvel     1

coor stat sele ( .not. segid SOLV ) .and. ( prop Z .lt. 18 ) .and. ( prop Z .gt. -18 ) end


! final carving out
set  deg    = 0
set  maxdeg = 90.0
set  dstep  = 12
calc ddeg   = @maxdeg / @dstep
define CARVE sele none end

label rotate
calc tzmax =   @Zinit / 2 + 2
calc tzmin =  -@Zinit / 2 - 2
set zslab  =   2
calc slabmax = @tzmax
calc slabmin = @tzmax - @zslab

label carve
coor stat sele ( .not. segid SOLV ) .and. ( prop Z .gt. @slabmin .and. prop Z .lt. @slabmax ) end
define CARVE sele CARVE .or. .byres. ( ( type OH2 ) .and. -
                           ( prop Z .gt. @slabmin .and. prop Z .lt. @slabmax ) .and. -
                           ( prop X .gt. ?xmax    .or. prop X .lt. ?xmin  .or. -
                             prop Y .gt. ?ymax    .or. prop Y .lt. ?ymin    ) ) end

calc slabmax = @slabmax - @zslab
calc slabmin = @slabmin - @zslab
if slabmax .gt. @tzmin goto carve

increase deg by @ddeg
if deg .lt. @maxdeg then
  coor rotate zdir 1.0 phi @ddeg sele all end
  goto rotate
endif
if deg .ge. @maxdeg then
  decrease deg by @ddeg
  coor rotate zdir -1.0 phi @deg sele all end
endif

delete atom sele CARVE end

!Remove overlapped water
define TOTO sele .not. hydrogen .and. .not. type OH2 end
coor stat sele TOTO end

delete atom sele .byres. ( type OH2 .and. ( TOTO .around. 2.8 ) ) end
!
! Step3: Individual Comparison
!

delete atom sele .not. segid SOLV end

join SOLV renumber
set ii = 1
coor stat sele type OH2 end
set nwater ?nsel
define LONE sele none end

label lonewater

coor stat sele .byres. ( type OH2 .and. ( segid SOLV .and. resid @ii ) .around. 3.5 ) end
if ?nsel .eq. 3 define LONE sele .byres. ( ( LONE ) .or. ( type OH2 .and. resid @ii ) ) end
increase ii by 1
if ii .le. @nwater goto lonewater

delete atom sele LONE end

!
! Write Coordinates
!

join SOLV renumber
coor stat sele type OH2 end
set nwater ?nsel

open write card unit 10 name step2.1_porewat.pdb
write coor pdb  unit 10
* Equilibrated water
*

open write unit 10 card name step2.1_porewat.crd
write coor unit 10 card
* Equilibrated water
*

open write unit 90 card name step2.1_pore.str
write title unit 90
* set nwater = @nwater
*
if nwater gt 0 then
   write title unit 90
   * read sequence TIP3 @nwater
   * generate PWAT setup noangle nodihedral
   *
endif
close unit 90

delete atom sele all end

!Read Protein & Water
open read unit 10 card name step1_pdbreader.psf
read psf  unit 10 card

open read unit 10 card name step2_orient.crd
read coor unit 10 card

stream step2.1_pore.str

open read card unit 10 name step2.1_porewat.crd
read coor card unit 10 append

open write card unit 10 name step2.1_pore.pdb
write coor pdb  unit 10

open write unit 10 card name step2.1_pore.crd
write coor unit 10 card

stop